(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();const G=12,Z=9,tt="ABCDEFGHIJKL".split("");function J(e){return e==="blue"?"蓝方":"红方"}function an(e){return e==="blue"?"p1":"p2"}function Re(e){return e.x>=0&&e.x<G&&e.y>=0&&e.y<Z}function ue(e,t){return Math.max(Math.abs(e.x-t.x),Math.abs(e.y-t.y))}function cn(e,t){const n=Math.abs(e.x-t.x),o=Math.abs(e.y-t.y);return n+o===1}function q(e,t){return e.x===t.x&&e.y===t.y}function $(e){return`${tt[e.x]}${e.y+1}`}function re(e){if(e.length<2)return null;const t=e[0]?.toUpperCase(),n=Number(e.slice(1)),o=tt.indexOf(t),r=n-1;if(o<0||Number.isNaN(n))return null;const i={x:o,y:r};return Re(i)?i:null}function se(e){return e==="blue"?"red":"blue"}function $e(e){return e==="role1"||e==="role2"||e==="role3"||e==="role4"}const Tt={x:1,y:4},At={x:10,y:4},bt=100,un=140,Ae=80,Pe=[];for(let e=3;e<=8;e+=1)Pe.push({x:3,y:e}),Pe.push({x:8,y:e});const dn=new Set(Pe.map(e=>$(e)));function Ge(e,t,n,o,r){return e.x>=t&&e.x<=o&&e.y>=n&&e.y<=r}function He(e){return Ge(e,2,0,4,1)||Ge(e,7,0,9,1)||Ge(e,4,7,7,8)}function fn(e){return q(e,Tt)?"spawnBlue":q(e,At)?"spawnRed":He(e)?"grass":"ground"}function St(e,t,n){return{id:an(e),side:e,pos:{...t},stats:{hp:20,spirit:n,maxSpirit:25,atk:1,vision:1,moveRange:1,gold:100},skills:{role1:!1,role2:!1,role3:!1,role4:!1},effects:{orbVisionRadius:0,orbTurns:0}}}function pn(){const e={};for(const t of Pe)e[$(t)]={hp:5,maxHp:5,alive:!0};return e}function vt(e){return{...e,pos:{...e.pos},stats:{...e.stats},skills:{...e.skills},effects:{...e.effects}}}function oe(e){return{blue:vt(e.blue),red:vt(e.red)}}function Be(e){const t={};for(const n of Object.keys(e))t[n]={...e[n]};return t}function mn(){return{seq:0,turn:{side:"blue",round:1,acted:!1,pendingAnnouncement:null},players:{blue:St("blue",Tt,0),red:St("red",At,1)},walls:pn(),announcements:[],winner:null}}function xt(e,t){return{type:"move",actor:e,to:$(t)}}function hn(e,t,n){return{type:"build",actor:e,to:$(t),spirit:n}}function gn(e){return{type:"scout",actor:e}}function Ct(e,t){return{type:"attack",actor:e,to:$(t)}}function kn(e,t,n){return{type:"needle",actor:e,to:$(t),spirit:n}}function yn(e,t){return{type:"amulet",actor:e,to:$(t),spirit:1}}function bn(e,t){return{type:"orb",actor:e,spirit:t}}function Sn(e,t,n){return{type:"blink",actor:e,to:$(t),spirit:n}}function vn(e,t){return{type:"unlockSkill",actor:e,skill:t}}function xn(e){return{type:"endTurn",actor:e}}function nt(e,t){return!e.winner&&e.turn.side===t}function K(e,t){return nt(e,t)&&!e.turn.acted}function ot(e,t){return nt(e,t)}function _e(e,t){return e.some(n=>q(n,t))}function rt(e,t){return!!e.walls[$(t)]?.alive}function Lt(e,t){return!!e[$(t)]?.alive}function $t(e,t){return rt(e,t)||q(e.players.blue.pos,t)||q(e.players.red.pos,t)}function Pt(e,t,n){if(rt(e,n))return!0;const o=e.players[se(t)];return q(o.pos,n)}function Cn(e){return Math.max(0,Math.floor(e))}function it(e){return e.players.blue.stats.hp<=0?"red":e.players.red.stats.hp<=0?"blue":null}function wn(e,t){const n=e.players[t];return n.effects.orbTurns>0?Math.max(n.stats.vision,n.effects.orbVisionRadius):n.stats.vision}function Ht(e,t){const n=e.x+.5,o=e.y+.5,r=t.x+.5,i=t.y+.5,a=r-n,l=i-o;if(a===0&&l===0)return[];let p=e.x,b=e.y;const y=a>0?1:a<0?-1:0,C=l>0?1:l<0?-1:0,A=a===0?Number.POSITIVE_INFINITY:Math.abs(1/a),E=l===0?Number.POSITIVE_INFINITY:Math.abs(1/l),N=y>0?p+1:p,k=C>0?b+1:b;let I=a===0?Number.POSITIVE_INFINITY:Math.abs((N-n)/a),P=l===0?Number.POSITIVE_INFINITY:Math.abs((k-o)/l);const T=[];for(;;){I<P?(p+=y,I+=A):P<I?(b+=C,P+=E):(p+=y,b+=C,I+=A,P+=E);const U={x:p,y:b};if(!Re(U))break;T.push(U)}return T}function st(e,t,n,o){if(n<=0)return!1;const r=e[t];if(r.stats.hp<=0)return!1;const i=Math.max(0,r.stats.hp-n);return r.stats.hp=i,o.push(`${J(t)}受到了${n}点伤害`),!0}function lt(e,t,n,o,r){if(r<=0)return!1;const i=$(o),a=t[i];if(!a||!a.alive)return!1;const l=a.hp-r;if(l<=0){const p=4*a.maxHp;e[n].stats.gold+=p,t[i]={...a,hp:0,alive:!1}}else t[i]={...a,hp:l};return!0}function Rt(e,t,n,o,r){return{kind:e,actor:t,origin:$(n),path:o.map(i=>$(i)),delayMs:r}}function be(e,t){if(t.length===0)return e.length<=Ae?e:e.slice(e.length-Ae);const n=[...e,...t];return n.length<=Ae?n:n.slice(n.length-Ae)}function Se(e,t){if(!K(e,t))return[];const n=[],o=e.players[t],r=e.players[se(t)];for(let i=-1;i<=1;i+=1)for(let a=-1;a<=1;a+=1){if(a===0&&i===0)continue;const l={x:o.pos.x+a,y:o.pos.y+i};Re(l)&&(ue(o.pos,l)>o.stats.moveRange||rt(e,l)||q(r.pos,l)||n.push(l))}return n}function Ve(e,t,n){if(!K(e,t))return[];if(!Number.isInteger(n)||n<=0)return[];if(e.players[t].stats.spirit<n)return[];const o=[],r=e.players[t];for(let i=0;i<Z;i+=1)for(let a=0;a<G;a+=1){const l={x:a,y:i},p=ue(r.pos,l);p<=0||p>n||$t(e,l)||o.push(l)}return o}function Bt(e,t){return K(e,t)&&e.players[t].stats.spirit>=1}function Oe(e,t){if(!K(e,t))return[];const n=[],o=e.players[t];for(let r=-1;r<=1;r+=1)for(let i=-1;i<=1;i+=1){if(i===0&&r===0)continue;const a={x:o.pos.x+i,y:o.pos.y+r};Re(a)&&(ue(o.pos,a)>1||Pt(e,t,a)&&n.push(a))}return n}function qe(e,t,n){if(!K(e,t))return[];if(!Number.isInteger(n)||n<=0)return[];if(e.players[t].stats.spirit<n)return[];if(!e.players[t].skills.role4)return[];const o=e.players[t],r=[];for(let i=0;i<Z;i+=1)for(let a=0;a<G;a+=1){const l={x:a,y:i},p=ue(o.pos,l);p<=0||p>n||$t(e,l)||r.push(l)}return r}function Ze(e,t){const n=Se(e,t),o=Oe(e,t).filter(r=>!_e(n,r));return{moveTargets:n,attackTargets:o}}function Mn(e,t){if(t.type!=="move")return{ok:!1,reason:"invalid move command type"};const n=t.actor;if(!K(e,n))return{ok:!1,reason:"cannot act now"};const o=re(t.to);if(!o)return{ok:!1,reason:"invalid target coordinate"};if(!_e(Se(e,n),o))return{ok:!1,reason:"illegal move target"};const i=e.players[n],a=cn(i.pos,o)?Math.min(i.stats.maxSpirit,i.stats.spirit+1):i.stats.spirit,l=oe(e.players);return l[n].pos={...o},l[n].stats.spirit=a,{ok:!0,state:{...e,players:l,turn:{...e.turn,acted:!0,pendingAnnouncement:`${J(n)}进行了移动`}}}}function En(e,t){if(t.type!=="build")return{ok:!1,reason:"invalid build command type"};const n=t.actor;if(!K(e,n))return{ok:!1,reason:"cannot act now"};const o=re(t.to);if(!o)return{ok:!1,reason:"invalid target coordinate"};if(!Number.isInteger(t.spirit)||t.spirit<=0)return{ok:!1,reason:"invalid spirit spend"};if(e.players[n].stats.spirit<t.spirit)return{ok:!1,reason:"not enough spirit"};if(!_e(Ve(e,n,t.spirit),o))return{ok:!1,reason:"illegal build target"};const i=oe(e.players);i[n].stats.spirit-=t.spirit;const a=$(o),l=Be(e.walls);return l[a]={hp:t.spirit,maxHp:t.spirit,alive:!0},{ok:!0,state:{...e,players:i,walls:l,turn:{...e.turn,acted:!0,pendingAnnouncement:`${J(n)}进行了建造`}}}}function In(e,t){if(t.type!=="scout")return{ok:!1,reason:"invalid scout command type"};const n=t.actor;if(!K(e,n))return{ok:!1,reason:"cannot act now"};if(e.players[n].stats.spirit<1)return{ok:!1,reason:"not enough spirit"};const r=e.players[se(n)],i=He(r.pos)?"无法被侦察":`坐标为(${r.pos.x+1},${r.pos.y+1})`,a=oe(e.players);return a[n].stats.spirit-=1,{ok:!0,state:{...e,players:a,turn:{...e.turn,acted:!0,pendingAnnouncement:`${J(n)}进行了侦察，${i}`}}}}function Nn(e,t){if(t.type!=="attack")return{ok:!1,reason:"invalid attack command type"};const n=t.actor;if(!K(e,n))return{ok:!1,reason:"cannot act now"};const o=re(t.to);if(!o)return{ok:!1,reason:"invalid target coordinate"};const r=e.players[n];if(ue(r.pos,o)>1||q(r.pos,o))return{ok:!1,reason:"attack target out of range"};if(!Pt(e,n,o))return{ok:!1,reason:"no valid target in tile"};const i=Cn(r.stats.atk),a=se(n),l=oe(e.players),p=Be(e.walls),b=[];q(l[a].pos,o)&&st(l,a,i,b),lt(l,p,n,o,i);const y=it({...e,players:l});return{ok:!0,state:{...e,players:l,walls:p,announcements:be(e.announcements,b),turn:{...e.turn,acted:!0,pendingAnnouncement:`${J(n)}进行了普通攻击。`},winner:y}}}function Tn(e,t){if(t.type!=="unlockSkill")return{ok:!1,reason:"invalid unlock command type"};const n=t.actor;if(!nt(e,n))return{ok:!1,reason:"cannot unlock now"};const o=e.players[n];if(o.skills[t.skill])return{ok:!1,reason:"skill already unlocked"};if(o.stats.gold<bt)return{ok:!1,reason:"not enough gold"};const r=oe(e.players);return r[n].stats.gold-=bt,r[n].skills[t.skill]=!0,{ok:!0,state:{...e,players:r}}}function An(e,t){if(t.type!=="needle")return{ok:!1,reason:"invalid needle command type"};const n=t.actor;if(!K(e,n))return{ok:!1,reason:"cannot act now"};const o=e.players[n];if(!o.skills.role1)return{ok:!1,reason:"skill role1 not unlocked"};if(!Number.isInteger(t.spirit)||t.spirit<=0)return{ok:!1,reason:"invalid spirit spend"};if(o.stats.spirit<t.spirit)return{ok:!1,reason:"not enough spirit"};const r=re(t.to);if(!r)return{ok:!1,reason:"invalid target coordinate"};const i=Ht(o.pos,r);if(i.length===0)return{ok:!1,reason:"invalid needle direction"};const a=se(n),l=oe(e.players),p=Be(e.walls),b=[],y=[];for(let N=0;N<t.spirit;N+=1){const k=[];for(const I of i){if(k.push(I),Lt(p,I)){lt(l,p,n,I,1);break}if(q(l[a].pos,I)){st(l,a,1,b);break}}y.push(Rt("needle",n,l[n].pos,k,N*un))}l[n].stats.spirit-=t.spirit;const C=it({...e,players:l});return{ok:!0,state:{...e,players:l,walls:p,announcements:be(e.announcements,b),turn:{...e.turn,acted:!0,pendingAnnouncement:`${J(n)}发射了封魔针`},winner:C},effects:{projectiles:y}}}function Ln(e,t){if(t.type!=="amulet")return{ok:!1,reason:"invalid amulet command type"};const n=t.actor;if(!K(e,n))return{ok:!1,reason:"cannot act now"};const o=e.players[n];if(!o.skills.role2)return{ok:!1,reason:"skill role2 not unlocked"};if(!Number.isInteger(t.spirit)||t.spirit!==1)return{ok:!1,reason:"amulet spirit must be 1"};if(o.stats.spirit<1)return{ok:!1,reason:"not enough spirit"};const r=re(t.to);if(!r)return{ok:!1,reason:"invalid target coordinate"};const i=Ht(o.pos,r);if(i.length===0)return{ok:!1,reason:"invalid amulet direction"};const a=se(n),l=oe(e.players),p=Be(e.walls),b=[],y=[];let C=!1;for(const k of i)y.push(k),Lt(p,k)&&lt(l,p,n,k,1),q(l[a].pos,k)&&(C=st(l,a,1,b)||C);const A=l[n].stats.spirit-1+(C?1:0);l[n].stats.spirit=Math.max(0,Math.min(l[n].stats.maxSpirit,A));const E=it({...e,players:l});return{ok:!0,state:{...e,players:l,walls:p,announcements:be(e.announcements,b),turn:{...e.turn,acted:!0,pendingAnnouncement:`${J(n)}发射了符札`},winner:E},effects:{projectiles:[Rt("amulet",n,l[n].pos,y,0)]}}}function $n(e,t){if(t.type!=="orb")return{ok:!1,reason:"invalid orb command type"};const n=t.actor;if(!K(e,n))return{ok:!1,reason:"cannot act now"};const o=e.players[n];if(!o.skills.role3)return{ok:!1,reason:"skill role3 not unlocked"};if(!Number.isInteger(t.spirit)||t.spirit<=0)return{ok:!1,reason:"invalid spirit spend"};if(o.stats.spirit<t.spirit)return{ok:!1,reason:"not enough spirit"};const r=oe(e.players);return r[n].stats.spirit-=t.spirit,r[n].effects.orbVisionRadius=t.spirit,r[n].effects.orbTurns=t.spirit,{ok:!0,state:{...e,players:r,turn:{...e.turn,acted:!0,pendingAnnouncement:`${J(n)}获得了半径为${t.spirit}的视野`}}}}function Pn(e,t){if(t.type!=="blink")return{ok:!1,reason:"invalid blink command type"};const n=t.actor;if(!K(e,n))return{ok:!1,reason:"cannot act now"};const o=e.players[n];if(!o.skills.role4)return{ok:!1,reason:"skill role4 not unlocked"};if(!Number.isInteger(t.spirit)||t.spirit<=0)return{ok:!1,reason:"invalid spirit spend"};if(o.stats.spirit<t.spirit)return{ok:!1,reason:"not enough spirit"};const r=re(t.to);if(!r)return{ok:!1,reason:"invalid target coordinate"};if(!_e(qe(e,n,t.spirit),r))return{ok:!1,reason:"illegal blink target"};const a=oe(e.players);return a[n].stats.spirit-=t.spirit,a[n].pos={...r},{ok:!0,state:{...e,players:a,turn:{...e.turn,acted:!0,pendingAnnouncement:`${J(n)}闪现到了半径为${t.spirit}内的一格`}}}}function Hn(e,t){const n=e[t].effects;n.orbTurns<=0||(n.orbTurns=Math.max(0,n.orbTurns-1),n.orbTurns===0&&(n.orbVisionRadius=0))}function Rn(e,t){if(t.type!=="endTurn")return{ok:!1,reason:"invalid endTurn command type"};if(e.winner)return{ok:!1,reason:"game has ended"};const n=t.actor;if(!ot(e,n))return{ok:!1,reason:"cannot end turn now"};const o=se(n),r=n==="red"?e.turn.round+1:e.turn.round,i=e.turn.pendingAnnouncement??(e.turn.acted?null:`${J(n)}选择了空过`),a=oe(e.players);return Hn(a,o),{ok:!0,state:{...e,players:a,announcements:i?be(e.announcements,[i]):be(e.announcements,[]),turn:{side:o,round:r,acted:!1,pendingAnnouncement:null}}}}function Bn(e,t){if(e.winner)return{ok:!1,reason:"game has ended"};switch(t.type){case"move":return Mn(e,t);case"build":return En(e,t);case"scout":return In(e,t);case"attack":return Nn(e,t);case"needle":return An(e,t);case"amulet":return Ln(e,t);case"orb":return $n(e,t);case"blink":return Pn(e,t);case"unlockSkill":return Tn(e,t);case"endTurn":return Rn(e,t);default:return{ok:!1,reason:"unsupported command"}}}function _n(e,t){const n=e.seq+1;if(t.seq!==n)return{ok:!1,reason:`sequence mismatch, expect ${n}, got ${t.seq}`};const o=Bn(e,t.command);return o.ok?{ok:!0,state:{...o.state,seq:t.seq},effects:o.effects}:o}function _t(e,t,n){const o=e.players[t];if(ue(o.pos,n)>wn(e,t))return!1;const r=He(o.pos),i=He(n);return!(!r&&i&&!q(n,o.pos))}function Vn(e,t,n){const o=$(n),r=_t(e,t,n),i=dn.has(o),a=!!e.walls[o]?.alive,l=r?a:i,p=r&&a?e.walls[o].hp:null;return{coord:n,terrain:fn(n),visible:r,hasWall:l,wallHp:p}}function et(e,t){const n=[];for(let l=0;l<Z;l+=1)for(let p=0;p<G;p+=1)n.push(Vn(e,t,{x:p,y:l}));const o=e.players[t],r=se(t),i=e.players[r].pos,a=_t(e,t,i);return{side:t,cells:n,pieces:{[t]:{...o.pos},...a?{[r]:{...i}}:{}}}}const On=256;function qn(){const e=new Date,t=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0"),o=String(e.getSeconds()).padStart(2,"0");return`${t}:${n}:${o}`}function Wn(e,t){const n={onConnectAction:null,onStartLoopback:null,onSideChange:null},o=new Map,r=new Map,i=document.createElement("section");i.className="panel debug-panel";const a=document.createElement("h3");a.className="debug-title",a.textContent=t.debugEnabled?"联机 Debug":"联机",i.appendChild(a);const l=document.createElement("div");l.className="debug-controls";const p=document.createElement("select");p.className="debug-input",p.innerHTML='<option value="blue">P1 / 蓝方</option><option value="red">P2 / 红方</option>',l.appendChild(p);const b=document.createElement("select");b.className="debug-input",b.innerHTML='<option value="receiver">接收模式</option><option value="connector">连接模式</option>',l.appendChild(b);const y=document.createElement("input");y.className="debug-input",y.placeholder="连接模式输入连接码",l.appendChild(y);const C=document.createElement("button");C.className="debug-btn",C.textContent="启动联机",l.appendChild(C);const A=document.createElement("button");A.className="debug-btn",A.textContent="Loopback",t.debugEnabled&&l.appendChild(A),i.appendChild(l);const E=document.createElement("div");E.className="debug-line",E.textContent="连接码: -",i.appendChild(E);const N=document.createElement("div");N.className="debug-line",N.textContent="状态: idle",i.appendChild(N);const k=document.createElement("div");k.className="debug-line",k.textContent="校验: 等待命令",i.appendChild(k);const I=document.createElement("div");I.className="debug-line",I.textContent="蓝方视角: -",i.appendChild(I);const P=document.createElement("div");P.className="debug-line",P.textContent="红方视角: -",i.appendChild(P);const T=document.createElement("pre");T.className="debug-log",i.appendChild(T),e.appendChild(i),t.debugEnabled||(k.style.display="none",I.style.display="none",P.style.display="none",T.style.display="none");function U(f){if(!t.debugEnabled)return;const x=`[${qn()}] ${f}`;if(!T.textContent){T.textContent=x;return}const W=`${x}
${T.textContent}`;T.textContent=W.split(`
`).slice(0,20).join(`
`)}function R(f){if(!t.debugEnabled)return;const x=o.get(f),W=r.get(f);if(!x){k.textContent="校验: 本地还没有可比较 hash";return}if(!W){k.textContent=`校验: seq=${f} 本地=${x} | 远端等待中`;return}const j=x===W;k.textContent=`校验: seq=${f} 本地=${x} 远端=${W} => ${j?"一致":"不一致"}`,j||U(`seq=${f} hash 不一致`)}function m(f){for(;f.size>On;){const x=f.keys().next().value;if(typeof x!="number")return;f.delete(x)}}function w(){const f=b.value==="connector";y.disabled=!f,y.style.opacity=f?"1":"0.65",y.placeholder=f?"连接模式输入连接码":"接收模式无需输入"}return b.addEventListener("change",w),w(),p.addEventListener("change",()=>{const f=p.value==="red"?"red":"blue";n.onSideChange?.(f),U(`本机身份切换为 ${f==="blue"?"P1/蓝方":"P2/红方"}`)}),C.addEventListener("click",()=>{const f=b.value==="connector"?"connector":"receiver";n.onConnectAction?.({mode:f,codeInput:y.value.trim()})}),A.addEventListener("click",()=>{n.onStartLoopback?.()}),{onConnectAction(f){n.onConnectAction=f},onStartLoopback(f){n.onStartLoopback=f},onSideChange(f){n.onSideChange=f},getSelectedSide(){return p.value==="red"?"red":"blue"},setTransportStatus(f){N.textContent=`状态: ${f.type} | ${f.detail}`,U(`状态更新: ${f.type} | ${f.detail}`)},setInviteHash(f){E.textContent=f?`连接码: ${f}`:"连接码: -"},log(f){t.debugEnabled?U(f):N.textContent=`状态: info | ${f}`},recordLocalHash(f,x){o.set(f,x),m(o),R(f)},recordRemoteHash(f,x){r.set(f,x),m(r),R(f)},updateDualView(f){if(!t.debugEnabled)return;const x=et(f,"blue"),W=et(f,"red"),j=x.cells.filter(X=>X.visible).length,de=W.cells.filter(X=>X.visible).length,fe=!!x.pieces.red,pe=!!W.pieces.blue,xe=$(f.players.blue.pos),ee=$(f.players.red.pos);I.textContent=`蓝方视角: 可见格=${j} 敌方可见=${fe?"是":"否"} 自身=${xe}`,P.textContent=`红方视角: 可见格=${de} 敌方可见=${pe?"是":"否"} 自身=${ee}`}}}function ce(e,t){return e.some(n=>q(n,t))}function Vt(e){return e.connected&&!e.game.winner&&e.game.turn.side===e.localSide&&!e.game.turn.acted}function ae(e){return e.game.players[e.localSide]}function ve(e,t){if(e!=="build"&&e!=="role1"&&e!=="role3"&&e!=="role4")return{min:0,max:0};const n=Math.max(0,Math.floor(ae(t).stats.spirit));return{min:n>0?1:0,max:n}}function Yn(e){const t=ve("build",e);if(t.max<1)return!1;for(let n=t.min;n<=t.max;n+=1)if(Ve(e.game,e.localSide,n).length>0)return!0;return!1}function jn(e){const t=ve("role4",e);if(t.max<1)return!1;for(let n=t.min;n<=t.max;n+=1)if(qe(e.game,e.localSide,n).length>0)return!0;return!1}function Ot(e){return e==="build"||e==="role1"||e==="role3"||e==="role4"}function le(){return{activeSkill:null,quickCast:!1,spiritSpend:1}}function qt(e){const t=ae(e),n={move:!1,build:!1,scout:!1,attack:!1,role1:!1,role2:!1,role3:!1,role4:!1};return Vt(e)?{move:Se(e.game,e.localSide).length>0,build:Yn(e),scout:Bt(e.game,e.localSide),attack:Oe(e.game,e.localSide).length>0,role1:t.skills.role1&&t.stats.spirit>=1,role2:t.skills.role2&&t.stats.spirit>=1,role3:t.skills.role3&&t.stats.spirit>=1,role4:t.skills.role4&&jn(e)}:n}function Dn(e,t,n){const o={...e,quickCast:!1};if(e.activeSkill===t)return{next:{...o,activeSkill:null}};if(!qt(n)[t])return{next:{...o,activeSkill:null}};if($e(t)&&!ae(n).skills[t])return{next:{...o,activeSkill:null}};const i=ve(t,n),a=i.max>0?Math.max(i.min,Math.min(i.max,o.spiritSpend)):1;return{next:{...o,activeSkill:t,spiritSpend:a}}}function Un(e,t,n){if(!Ot(e.activeSkill))return{next:{...e}};const o=ve(e.activeSkill,n);if(o.max<1)return{next:{...e,spiritSpend:1}};const r=Math.max(o.min,Math.min(o.max,e.spiritSpend+t));return{next:{...e,spiritSpend:r}}}function Xn(e,t,n){if(!n.connected)return{next:{...e,activeSkill:null,quickCast:!1}};if(e.quickCast){const r=Ze(n.game,n.localSide),i=ae(n).pos;return q(t,i)?{next:{...e,quickCast:!1}}:ce(r.moveTargets,t)?{next:{...e,activeSkill:null,quickCast:!1},command:xt(n.localSide,t)}:ce(r.attackTargets,t)?{next:{...e,activeSkill:null,quickCast:!1},command:Ct(n.localSide,t)}:{next:{...e}}}if(e.activeSkill==="move"){const r=Se(n.game,n.localSide);return ce(r,t)?{next:{...e,activeSkill:null},command:xt(n.localSide,t)}:{next:{...e}}}if(e.activeSkill==="build"){const r=Ve(n.game,n.localSide,e.spiritSpend);return ce(r,t)?{next:{...e,activeSkill:null},command:hn(n.localSide,t,e.spiritSpend)}:{next:{...e}}}if(e.activeSkill==="attack"){const r=Oe(n.game,n.localSide);return ce(r,t)?{next:{...e,activeSkill:null},command:Ct(n.localSide,t)}:{next:{...e}}}if(e.activeSkill==="scout")return Bt(n.game,n.localSide)?{next:{...e,activeSkill:null},command:gn(n.localSide)}:{next:{...e,activeSkill:null}};if(e.activeSkill==="role1"){const r=ae(n).pos;return q(r,t)?{next:{...e}}:{next:{...e,activeSkill:null},command:kn(n.localSide,t,e.spiritSpend)}}if(e.activeSkill==="role2"){const r=ae(n).pos;return q(r,t)?{next:{...e}}:{next:{...e,activeSkill:null},command:yn(n.localSide,t)}}if(e.activeSkill==="role3")return{next:{...e,activeSkill:null},command:bn(n.localSide,e.spiritSpend)};if(e.activeSkill==="role4"){const r=qe(n.game,n.localSide,e.spiritSpend);return ce(r,t)?{next:{...e,activeSkill:null},command:Sn(n.localSide,t,e.spiritSpend)}:{next:{...e}}}const o=ae(n).pos;if(q(t,o)&&Vt(n)){const r=Ze(n.game,n.localSide);if(r.moveTargets.length>0||r.attackTargets.length>0)return{next:{...e,quickCast:!0,activeSkill:null}}}return{next:{...e}}}function Fn(e,t){return!t.connected||t.ballisticPending||!ot(t.game,t.localSide)?{next:{...e}}:{next:{...e,activeSkill:null,quickCast:!1},command:xn(t.localSide)}}function Kn(e,t){if(e.quickCast){const n=Ze(t.game,t.localSide);return{moveHighlights:n.moveTargets,attackHighlights:n.attackTargets}}return e.activeSkill==="move"?{moveHighlights:Se(t.game,t.localSide),attackHighlights:[]}:e.activeSkill==="build"?{moveHighlights:Ve(t.game,t.localSide,e.spiritSpend),attackHighlights:[]}:e.activeSkill==="attack"?{moveHighlights:[],attackHighlights:Oe(t.game,t.localSide)}:e.activeSkill==="role4"?{moveHighlights:qe(t.game,t.localSide,e.spiritSpend),attackHighlights:[]}:{moveHighlights:[],attackHighlights:[]}}function zn(e,t){if(!Ot(e.activeSkill))return{visible:!1,value:0,min:0,max:0};const n=ve(e.activeSkill,t);return n.max<1?{visible:!1,value:0,min:0,max:0}:{visible:!0,value:Math.max(n.min,Math.min(n.max,e.spiritSpend)),min:n.min,max:n.max}}class Wt{constructor(){this.messageHandler=null,this.statusHandler=null}onMessage(t){this.messageHandler=t}onStatus(t){this.statusHandler=t}emitStatus(t,n){this.statusHandler?.({type:t,detail:n})}emitMessage(t){this.messageHandler?.(t)}}class Gn extends Wt{constructor(){super(...arguments),this.name="loopback",this.localId="loopback-local"}start(){this.emitStatus("ready","loopback ready")}connect(t){this.emitStatus("connected",`loopback connected: ${t||"self"}`)}send(t){window.setTimeout(()=>{this.emitMessage(t)},0)}getLocalId(){return this.localId}dispose(){this.emitStatus("closed","loopback closed")}}class Jn extends Wt{constructor(t,n){super(),this.name="peerjs",this.peer=null,this.connection=null,this.localId="",this.preferredId=t.trim(),this.runtimeConfig=n}start(){const t=window.Peer;if(!t){this.emitStatus("error","PeerJS not loaded");return}if(this.emitStatus("connecting","creating peer"),this.runtimeConfig&&Array.isArray(this.runtimeConfig.iceServers)){const n={config:{iceServers:this.runtimeConfig.iceServers}};this.peer=this.preferredId?new t(this.preferredId,n):new t(n)}else this.peer=this.preferredId?new t(this.preferredId):new t;this.peer.on("open",n=>{this.localId=n,this.emitStatus("ready",`peer ready: ${n}`)}),this.peer.on("connection",n=>{this.attachConnection(n,!0)}),this.peer.on("error",n=>{this.emitStatus("error",`peer error: ${String(n)}`)}),this.peer.on("disconnected",()=>{this.emitStatus("error","peer disconnected")}),this.peer.on("close",()=>{this.emitStatus("closed","peer closed")})}connect(t){if(!this.peer){this.emitStatus("error","start peer first");return}const n=t.trim();if(!n){this.emitStatus("error","remote id is empty");return}const o=this.peer.connect(n,{reliable:!0});this.attachConnection(o,!1)}send(t){if(!this.connection||!this.connection.open){this.emitStatus("error","connection not open");return}this.connection.send(t)}getLocalId(){return this.localId||this.preferredId}dispose(){this.connection&&(this.connection.close(),this.connection=null),this.peer&&(this.peer.destroy(),this.peer=null),this.emitStatus("closed","transport disposed")}attachConnection(t,n){if(this.connection&&this.connection.open){t.close(),this.emitStatus("error","only one data connection is allowed");return}this.connection=t,this.emitStatus("connecting",n?"incoming connection":"connecting to remote"),t.on("open",()=>{this.emitStatus("connected",`connected: ${t.peer}`)}),t.on("data",o=>{if(!o||typeof o!="object"){this.emitStatus("error","invalid message payload");return}this.emitMessage(o)}),t.on("close",()=>{this.emitStatus("ready","data channel closed"),this.connection=null}),t.on("error",o=>{this.emitStatus("error",`connection error: ${String(o)}`)})}}function Qn(){return new Gn}function wt(e,t){return new Jn(e,t)}const Mt=[{id:"move",label:"移動",basic:!0},{id:"build",label:"建造",basic:!0},{id:"scout",label:"偵察",basic:!0},{id:"attack",label:"普攻",basic:!0},{id:"role1",label:"",basic:!1},{id:"role2",label:"",basic:!1},{id:"role3",label:"",basic:!1},{id:"role4",label:"",basic:!1}],Zn={move:"进行一次距离为1的8向移动。当朝向正上下左右移动时，使自身灵力+1，否则不变。无法移动至墙体或其他机体。",build:"消费N灵力，在距离为N的范围内建造生命值/生命值上限为N的墙体。墙体无法建造在任意单位之上。",scout:"消费1灵力，立刻获得对方坐标。",attack:"消费0灵力，进行一次距离为1的攻击。",role1:"耗N灵力，朝目标方向逐发N枚封魔针，命中首个单位造1伤害。",role2:"消费1灵力，造成穿透伤害，对路径上所有单位造成1伤害，对敌机造成伤害后返还1灵力。",role3:"耗N灵力，获得半径N视野，持续N回合。",role4:"耗N灵力，闪现至半径N内空格（非移动）。"},eo=new Set(["build","role1","role3","role4"]);function z(e){return new Promise((t,n)=>{const o=new Image;o.src=e,o.onload=()=>t(o),o.onerror=()=>n(new Error(`load image failed: ${e}`))})}async function Le(e){const[t,n,o]=await Promise.all([z(`./assets/skill/reimu/${e}.png`),z(`./assets/skill/reimu/${e}_selected.png`),z(`./assets/skill/reimu/${e}_selecting.png`)]);return{normal:t,selected:n,selecting:o}}async function to(){const[e,t,n,o,r,i,a,l,p,b,y,C]=await Promise.all([z("./assets/tiles/ground.png"),z("./assets/tiles/grass.png"),z("./assets/tiles/spawn.png"),z("./assets/tiles/wall.png"),z("./assets/char/reimu.png"),z("./assets/bullet/reimu/reimuneedle.png"),z("./assets/bullet/reimu/reimuamulet.png"),z("./assets/bullet/reimu/yinyangorb.png"),Le("reimu_1"),Le("reimu_2"),Le("reimu_3"),Le("reimu_4")]),A=new Map,E=new Map,N=[];for(let k=1;k<=10;k+=1){const P=`./assets/number/${k===10?"no10.png":`no${k}.png`}`;E.set(k,P),N.push(z(P).then(T=>{A.set(k,T)}))}return await Promise.all(N),{ground:e,grass:t,spawn:n,wall:o,char:r,needle:i,amulet:a,orbEffect:l,roleIcons:{role1:p,role2:b,role3:y,role4:C},numbers:A,numberSrc:E}}function Je(e,t,n){return e[n*G+t]}function no(e,t){return!e&&!t?!0:!e||!t?!1:e.x===t.x&&e.y===t.y}function oo(e,t){const n=e.x+.5,o=e.y+.5,r=t.x+.5-n,i=t.y+.5-o;if(r===0&&i===0)return null;let a=Number.POSITIVE_INFINITY;return r>0?a=Math.min(a,(G-n)/r):r<0&&(a=Math.min(a,(0-n)/r)),i>0?a=Math.min(a,(Z-o)/i):i<0&&(a=Math.min(a,(0-o)/i)),!Number.isFinite(a)||a<=0?null:{x:n+r*a,y:o+i*a}}function ro(e){return e*(2-e)}function io(e){return e*e}function Et(e,t){if(t<=0)return null;const n=Math.min(10,Math.floor(t));return e.numbers.get(n)??null}function so(e,t){if(t<=0)return null;const n=Math.min(10,Math.floor(t));return e.numberSrc.get(n)??null}function lo(e){return!!(e&&eo.has(e))}function Qe(e){return e==="role1"||e==="role2"||e==="role4"}async function ao(e){const t=await to();let n={onCellClick:()=>{},onSkillClick:()=>{},onUnlockSkill:()=>{},onEndTurnClick:()=>{},onSpiritAdjust:()=>{}},o=null,r=null,i=null,a=0,l=null,p=0,b=0;const y=[],C=new Map,A=document.createElement("div");A.className="game-shell";const E=document.createElement("div");E.className="game-frame",A.appendChild(E);const N=document.createElement("section");N.className="panel board-panel",E.appendChild(N);const k=document.createElement("div");k.className="turn-bar",N.appendChild(k);const I=document.createElement("span");I.className="turn-side turn-blue",I.textContent="蓝方",k.appendChild(I);const P=document.createElement("span");P.className="turn-center",P.textContent="第1回合",k.appendChild(P);const T=document.createElement("span");T.className="turn-side turn-red",T.textContent="红方",k.appendChild(T);const U=document.createElement("div");U.className="board-canvas-wrap",N.appendChild(U);const R=document.createElement("canvas");R.className="board-canvas",U.appendChild(R);const m=document.createElement("section");m.className="panel announcement-panel",E.appendChild(m);const w=document.createElement("h3");w.className="panel-title",w.textContent="公告",m.appendChild(w);const f=document.createElement("div");f.className="announcement-list",m.appendChild(f);const x=document.createElement("section");x.className="panel skill-panel",E.appendChild(x);const W=document.createElement("div");W.className="skill-layout",x.appendChild(W);const j=document.createElement("div");j.className="skill-left",W.appendChild(j);const de=document.createElement("div");de.className="basic-skill-grid",j.appendChild(de);const fe=document.createElement("div");fe.className="role-skill-grid",j.appendChild(fe);const pe=new Map,xe=new Map,ee=document.createElement("div");ee.className="skill-tooltip",ee.style.display="none",x.appendChild(ee);const X=document.createElement("div");X.className="unlock-popup",X.style.display="none";const Ce=document.createElement("div");Ce.className="unlock-text",Ce.textContent="使用100金币解锁技能？",X.appendChild(Ce);const We=document.createElement("div");We.className="unlock-actions";const me=document.createElement("button");me.className="unlock-btn",me.textContent="解锁";const we=document.createElement("button");we.className="unlock-btn",we.textContent="取消",We.append(me,we),X.appendChild(We),x.appendChild(X);let Me=null;function Ee(){X.style.display="none",Me=null}function Ye(){ee.style.display="none"}function Yt(s,u){const c=Zn[s];if(!c)return;ee.textContent=c,ee.style.display="block";const v=x.getBoundingClientRect(),h=u.getBoundingClientRect(),M=h.left-v.left+(h.width-210)*.5,d=h.top-v.top-52;ee.style.left=`${Math.max(0,M)}px`,ee.style.top=`${Math.max(0,d)}px`}function jt(s,u){if(!o)return;const c=o.state.players[o.localSide],v=!o.state.winner&&o.connected&&o.state.turn.side===o.localSide&&!c.skills[s]&&c.stats.gold>=100;Me=s,Ce.textContent=v?"使用100金币解锁该技能？":"金币不足或当前不可解锁",me.disabled=!v;const h=x.getBoundingClientRect(),S=u.getBoundingClientRect(),M=182,d=82,_=S.left-h.left+(S.width-M)*.5,Y=S.top-h.top-d-6;X.style.display="block",X.style.left=`${Math.max(0,_)}px`,X.style.top=`${Math.max(0,Y)}px`}me.addEventListener("click",()=>{if(!Me)return;const s=Me;Ee(),n.onUnlockSkill(s)}),we.addEventListener("click",()=>{Ee()});for(const s of Mt){const u=document.createElement("button");if(u.className=`skill-btn hollow-frame ${s.basic?"skill-basic":"skill-role"}`,u.textContent=s.label,u.dataset.skill=s.id,!s.basic&&$e(s.id)){const c=document.createElement("img");c.className="skill-duration",c.alt="duration",c.draggable=!1,c.style.display="none",u.appendChild(c),xe.set(s.id,c)}u.addEventListener("mouseenter",()=>{Yt(s.id,u)}),u.addEventListener("mouseleave",()=>{Ye()}),u.addEventListener("click",()=>{if(o){if(Ye(),$e(s.id)&&!o.state.players[o.localSide].skills[s.id]){jt(s.id,u);return}Ee(),n.onSkillClick(s.id)}}),s.basic?de.appendChild(u):fe.appendChild(u),pe.set(s.id,u)}const te=document.createElement("div");te.className="spirit-popup";const he=document.createElement("button");he.className="spirit-btn",he.textContent="▲",he.addEventListener("click",()=>n.onSpiritAdjust(1)),te.appendChild(he);const je=document.createElement("div");je.className="spirit-value",te.appendChild(je);const ge=document.createElement("button");ge.className="spirit-btn",ge.textContent="▼",ge.addEventListener("click",()=>n.onSpiritAdjust(-1)),te.appendChild(ge),x.appendChild(te);const De=document.createElement("div");De.className="skill-actions",W.appendChild(De);const ke=document.createElement("button");ke.className="end-turn-btn hollow-frame",ke.textContent="结束回合",ke.addEventListener("click",()=>{n.onEndTurnClick()}),De.appendChild(ke);const Ie=document.createElement("section");Ie.className="panel status-panel",E.appendChild(Ie);const Ue=document.createElement("h3");Ue.className="panel-title",Ue.textContent="数值",Ie.appendChild(Ue);const Xe=document.createElement("div");Xe.className="status-list",Ie.appendChild(Xe);const at=document.createElement("div"),ct=document.createElement("div"),ut=document.createElement("div"),dt=document.createElement("div"),ft=document.createElement("div");Xe.append(at,ct,ut,dt,ft),e.innerHTML="",e.appendChild(A);function Dt(){const s=R.getBoundingClientRect(),u=window.devicePixelRatio||1;return R.width=Math.max(1,Math.floor(s.width*u)),R.height=Math.max(1,Math.floor(s.height*u)),{dpr:u,width:R.width/u,height:R.height/u}}function Ut(s){if(!i||i.actor!==s)return null;const u=performance.now()-i.startedAt,c=Math.max(0,Math.min(1,u/i.durationMs));if(c>=1)return i=null,null;if(c<.5){const h=ro(c*2);return{x:i.from.x+(i.to.x-i.from.x)*h,y:i.from.y+(i.to.y-i.from.y)*h}}const v=io((c-.5)*2);return{x:i.to.x+(i.from.x-i.to.x)*v,y:i.to.y+(i.from.y-i.to.y)*v}}function Xt(s,u){const c=u-s.startedAt-s.delayMs;if(c<0)return null;const v=s.points.length-1;if(v<=0)return null;const h=Math.max(0,Math.min(1,c/s.durationMs));if(h>=1)return null;const S=h*v,M=Math.floor(S),d=Math.min(1,S-M),_=s.points[M],Y=s.points[Math.min(M+1,s.points.length-1)],D=Y.x-_.x,F=Y.y-_.y;return{pos:{x:_.x+D*d,y:_.y+F*d},angle:Math.atan2(F,D)+Math.PI/2}}function pt(s){if(s.done)return;s.done=!0;const u=C.get(s.batchId);u&&(u.pending-=1,u.pending<=0&&(C.delete(s.batchId),u.resolve()))}function Ft(s){const u=Dt(),c=R.getContext("2d");if(!c)return;const{dpr:v,width:h,height:S}=u;c.setTransform(v,0,0,v,0,0),c.imageSmoothingEnabled=!1,c.clearRect(0,0,h,S),c.fillStyle="#000",c.fillRect(0,0,h,S);const M=Math.max(20,Math.floor(Math.min(h,S)*.05)),d=Math.max(12,Math.floor(Math.min((h-M*2)/G,(S-M*2)/Z))),_=d*G,Y=d*Z,D=Math.floor((h-_-M)*.5+M),F=Math.floor((S-Y-M)*.5+M);r={left:D,top:F,tile:d,width:_,height:Y};const tn=new Set(s.highlights.moveHighlights.map(g=>$(g))),nn=new Set(s.highlights.attackHighlights.map(g=>$(g)));c.fillStyle="#fff",c.font=`${Math.max(11,Math.floor(d*.38))}px 'zpix', monospace`,c.textAlign="center",c.textBaseline="middle";for(let g=0;g<G;g+=1)c.fillText(tt[g],D+g*d+d*.5,F-Math.floor(M*.45));for(let g=0;g<Z;g+=1)c.fillText(String(g+1),D-Math.floor(M*.45),F+g*d+d*.5);const on=(g,H,L)=>{let B=t.ground;g.terrain==="grass"?B=t.grass:(g.terrain==="spawnBlue"||g.terrain==="spawnRed")&&(B=t.spawn),c.drawImage(B,H,L,d,d),g.hasWall&&c.drawImage(t.wall,H,L,d,d),g.visible||(c.fillStyle="rgba(0,0,0,0.65)",c.fillRect(H,L,d,d))};for(let g=0;g<Z;g+=1)for(let H=0;H<G;H+=1){const L=Je(s.perspective.cells,H,g),B=D+H*d,V=F+g*d;on(L,B,V),tn.has($(L.coord))&&(c.fillStyle="rgba(80, 160, 255, 0.35)",c.fillRect(B,V,d,d)),nn.has($(L.coord))&&(c.fillStyle="rgba(255, 80, 80, 0.35)",c.fillRect(B,V,d,d)),c.strokeStyle="rgba(255,255,255,0.2)",c.lineWidth=1,c.strokeRect(B+.5,V+.5,d-1,d-1)}for(let g=0;g<Z;g+=1)for(let H=0;H<G;H+=1){const L=Je(s.perspective.cells,H,g);if(L.wallHp===null||L.wallHp<=0)continue;const B=Et(t,L.wallHp);if(!B)continue;const V=D+H*d,Q=F+g*d,O=Math.floor(d*.58);c.drawImage(B,V+Math.floor((d-O)*.5),Q+Math.floor((d-O)*.5),O,O)}const Ke=performance.now(),ht=g=>{const H=s.perspective.pieces[g];if(!H)return;const B=Ut(g)??H,V=D+B.x*d,Q=F+B.y*d,O=Math.floor(d*.08);c.drawImage(t.char,V+O,Q+O,d-O*2,d-O*2),c.strokeStyle=g==="blue"?"#58a8ff":"#ff6565",c.lineWidth=Math.max(2,Math.floor(d*.08)),c.strokeRect(V+2,Q+2,d-4,d-4);const ne=s.state.players[g];if(ne.effects.orbTurns>0){const ie=V+d*.5,rn=Q+d*.5,gt=d*(.28+Math.min(.5,ne.effects.orbVisionRadius*.04)),kt=Ke*.004+(g==="blue"?0:Math.PI),Te=Math.floor(d*.42),sn=ie+Math.cos(kt)*gt-Te*.5,ln=rn+Math.sin(kt)*gt-Te*.5;c.drawImage(t.orbEffect,sn,ln,Te,Te);const yt=Et(t,ne.effects.orbTurns);if(yt){const ze=Math.floor(d*.34);c.drawImage(yt,V+d-ze-2,Q+2,ze,ze)}}};ht("blue"),ht("red");const Ne=s.input.activeSkill;if(Qe(Ne)&&l){const g=s.state.players[s.localSide].pos,H=D+l.x*d,L=F+l.y*d,B=Ne==="role4"?"rgba(90, 170, 255, 0.95)":"rgba(255, 66, 66, 0.95)";c.save(),c.fillStyle=Ne==="role4"?"rgba(90, 170, 255, 0.26)":"rgba(255, 66, 66, 0.24)",c.fillRect(H,L,d,d),c.strokeStyle=B,c.lineWidth=Math.max(2,Math.floor(d*.08)),c.strokeRect(H+1,L+1,d-2,d-2),c.restore();const V=Ne==="role4"?{x:l.x+.5,y:l.y+.5}:oo(g,l);if(V){const Q=D+(g.x+.5)*d,O=F+(g.y+.5)*d,ne=D+V.x*d,ie=F+V.y*d;(Math.abs(ne-Q)>=.01||Math.abs(ie-O)>=.01)&&(c.save(),c.strokeStyle=B,c.lineWidth=Math.max(2,Math.floor(d*.08)),c.setLineDash([Math.max(4,Math.floor(d*.22)),Math.max(2,Math.floor(d*.13))]),c.beginPath(),c.moveTo(Q,O),c.lineTo(ne,ie),c.stroke(),c.setLineDash([]),c.restore())}}for(const g of y){if(g.done)continue;const H=g.startedAt+g.delayMs+g.durationMs;if(Ke>=H){pt(g);continue}const L=Xt(g,Ke);if(!L)continue;if(g.actor!==s.localSide){const ne=Math.floor(L.pos.x),ie=Math.floor(L.pos.y);if(ne<0||ne>=G||ie<0||ie>=Z||!Je(s.perspective.cells,ne,ie).visible)continue}const B=g.kind==="needle"?t.needle:t.amulet,V=D+(L.pos.x+.5)*d,Q=F+(L.pos.y+.5)*d,O=Math.floor(d*(g.kind==="needle"?.52:.58));c.save(),c.translate(V,Q),c.rotate(L.angle),c.drawImage(B,-O*.5,-O*.5,O,O),c.restore()}}function Kt(s){const u=s.input.activeSkill;if(!(s.spiritSelector.visible&&lo(u))||!u){te.style.display="none";return}const v=pe.get(u);if(!v){te.style.display="none";return}te.style.display="flex",je.textContent=String(s.spiritSelector.value),he.disabled=s.spiritSelector.value>=s.spiritSelector.max,ge.disabled=s.spiritSelector.value<=s.spiritSelector.min;const h=x.getBoundingClientRect(),S=v.getBoundingClientRect(),M=70,d=64,_=S.left-h.left+(S.width-M)*.5,Y=S.top-h.top-d-6;te.style.left=`${Math.max(0,_)}px`,te.style.top=`${Math.max(0,Y)}px`}function mt(s,u){if(!r)return null;const c=R.getBoundingClientRect(),v=s-c.left,h=u-c.top;return v>=r.left&&v<r.left+r.width&&h>=r.top&&h<r.top+r.height?{x:Math.floor((v-r.left)/r.tile),y:Math.floor((h-r.top)/r.tile)}:null}R.addEventListener("mousemove",s=>{const u=mt(s.clientX,s.clientY);no(u,l)||(l=u,o&&Qe(o.input.activeSkill)&&ye(o))}),R.addEventListener("mouseleave",()=>{l&&(l=null,o&&Qe(o.input.activeSkill)&&ye(o))}),R.addEventListener("click",s=>{Ee(),Ye();const u=mt(s.clientX,s.clientY);u&&n.onCellClick(u)});function zt(s){const u=s.skillAvailability,c=s.state.players[s.localSide];for(const h of Mt){const S=pe.get(h.id);if(!S)continue;const M=$e(h.id),d=!M||c.skills[h.id],_=d&&u[h.id];if(S.classList.toggle("skill-usable",_),S.classList.toggle("skill-disabled",!_),S.classList.toggle("skill-selected",s.input.activeSkill===h.id),S.classList.toggle("skill-quickcast",s.input.quickCast&&h.id==="move"),S.classList.toggle("skill-locked",M&&!d),S.disabled=!1,M){const Y=t.roleIcons[h.id],D=s.input.activeSkill===h.id?Y.selected:_?Y.selecting:Y.normal;S.style.backgroundImage=`url('${D.src}')`}else S.style.backgroundImage="none"}const v=c.effects.orbTurns;for(const[h,S]of xe){if(h!=="role3"){S.style.display="none";continue}const M=so(t,v);if(!M||!c.skills.role3){S.style.display="none";continue}S.src=M,S.style.display="block"}ke.disabled=!s.connected||s.ballisticPending||!ot(s.state,s.localSide),Kt(s)}function Gt(s){if(s.state.winner){I.classList.remove("turn-active"),T.classList.remove("turn-active"),P.textContent=`${J(s.state.winner)}获胜`;return}const u=s.state.turn.side;I.classList.toggle("turn-active",u==="blue"),T.classList.toggle("turn-active",u==="red"),P.textContent=`第${s.state.turn.round}回合 | 当前: ${J(u)}`+(s.ballisticPending?" | 弹道结算中":"")}function Jt(s){const u=s.state.players[s.localSide];at.textContent=`生命值: ${u.stats.hp}`,ct.textContent=`当前灵力/灵力上限: ${u.stats.spirit}/${u.stats.maxSpirit}`,ut.textContent=`攻击力: ${u.stats.atk}`,dt.textContent=`坐标: ${$(u.pos)}`,ft.textContent=`金币: ${u.stats.gold}`}function Qt(s){const u=s.state.announcements;if(f.innerHTML="",u.length===0){const v=document.createElement("div");v.className="announcement-item",v.textContent="暂无公告",f.appendChild(v);return}const c=[...u].reverse();for(const v of c){const h=document.createElement("div");h.className="announcement-item",h.textContent=v,f.appendChild(h)}}function Zt(s){return s?i||y.some(u=>!u.done)?!0:s.state.players.blue.effects.orbTurns>0||s.state.players.red.effects.orbTurns>0:!1}function ye(s){o=s,Ft(s),zt(s),Gt(s),Jt(s),Qt(s),Zt(s)&&Fe()}function en(){if(a=0,!o)return;const s=performance.now();for(const u of y){if(u.done)continue;const c=u.startedAt+u.delayMs+u.durationMs;s>=c&&pt(u)}for(let u=y.length-1;u>=0;u-=1)y[u].done&&y.splice(u,1);ye(o)}function Fe(){a===0&&(a=window.requestAnimationFrame(en))}return window.addEventListener("resize",()=>{o&&ye(o)}),{setHandlers(s){n=s},render:ye,playAttackAnimation(s,u,c){i={actor:s,from:{...u},to:{...c},startedAt:performance.now(),durationMs:280},Fe()},playProjectileAnimations(s){if(s.length===0)return Promise.resolve();const u=++b,c=performance.now(),v=[];for(const h of s){const S=re(h.origin);if(!S)continue;const M=[];for(const _ of h.path){const Y=re(_);Y&&M.push(Y)}const d=[S,...M];v.push({id:++p,batchId:u,kind:h.kind,actor:h.actor,points:d,startedAt:c,delayMs:Math.max(0,h.delayMs),durationMs:Math.max(220,Math.max(1,d.length-1)*90),done:!1})}if(v.length===0)return Promise.resolve();for(const h of v)y.push(h);return Fe(),new Promise(h=>{C.set(u,{pending:v.length,resolve:h})})}}}function co(e){return e.kind==="command"}function It(){return`thchess-${Math.random().toString(36).slice(2,10)}`}function uo(e){const t=e.trim();return t.length>0?t:null}const Nt=[{urls:"stun:stun.l.google.com:19302"}];function fo(){const e='[{"urls":"stun:stun.relay.metered.ca:80"},{"urls":"turn:global.relay.metered.ca:80","username":"329dbdd5c5b60609dbfead99","credential":"HN3XYHHIYayjEpS/"},{"urls":"turn:global.relay.metered.ca:80?transport=tcp","username":"329dbdd5c5b60609dbfead99","credential":"HN3XYHHIYayjEpS/"},{"urls":"turn:global.relay.metered.ca:443","username":"329dbdd5c5b60609dbfead99","credential":"HN3XYHHIYayjEpS/"},{"urls":"turns:global.relay.metered.ca:443?transport=tcp","username":"329dbdd5c5b60609dbfead99","credential":"HN3XYHHIYayjEpS/"}]'.trim();if(!e)return{iceServers:Nt};try{const t=JSON.parse(e);if(Array.isArray(t)&&t.length>0)return{iceServers:t}}catch(t){console.warn("invalid VITE_ICE_SERVERS_JSON, fallback to default STUN",t)}return{iceServers:Nt}}async function po(){const e=document.getElementById("app"),t=document.getElementById("debug-root");if(!e||!t)throw new Error("missing #app or #debug-root");const n=new URLSearchParams(window.location.search).has("debug"),o=await ao(e),r=Wn(t,{debugEnabled:n});let i=mn(),a=r.getSelectedSide(),l=le(),p=null,b=!1,y=!1,C=null,A=0,E=null;const N=fo(),k=()=>{const m={game:i,localSide:a,connected:b};o.render({state:i,perspective:et(i,a),localSide:a,connected:b,ballisticPending:y,input:l,highlights:Kn(l,m),skillAvailability:qt(m),spiritSelector:zn(l,m)}),r.updateDualView(i)},I=(m,w)=>{const f=i,x=_n(i,m);if(!x.ok)return r.log(`${w} 命令拒绝: ${x.reason}`),!1;if(i=x.state,l=le(),m.command.type==="endTurn"&&(y=!1),m.command.type==="attack"){const j=re(m.command.to);j&&o.playAttackAnimation(m.command.actor,f.players[m.command.actor].pos,j)}const W=x.effects?.projectiles??[];if(W.length>0){const j=m.command.actor===a;j&&(y=!0),o.playProjectileAnimations(W).then(()=>{j&&(y=!1,k())})}return k(),!0},P=m=>{if(!p||!b){r.log("未连接，命令未发送");return}n&&r.log(`send command seq=${m.seq} actor=${m.command.actor} type=${m.command.type}`),p.send(m)},T=m=>{if(!b){r.log("连接未完成，暂时无法操作");return}const w={kind:"command",seq:i.seq+1,command:m};I(w,"local")&&P(w)},U=(m,w)=>{if(w===A){if(r.setTransportStatus(m),m.type==="connected"){b=!0,k();return}if(m.type==="ready"){if(b=!1,l=le(),y=!1,E==="receiver"&&p){const f=p.getLocalId();r.setInviteHash(f)}if(E==="connector"&&C&&p){const f=C;C=null,p.connect(f)}k();return}if(m.type==="connecting"){b=!1,l=le(),y=!1,k();return}b=!1,l=le(),y=!1,k()}},R=m=>{p&&p.dispose(),p=m,A+=1;const w=A;p.onStatus(f=>{U(f,w)}),p.onMessage(f=>{if(w===A&&co(f)){if(n&&r.log(`recv command seq=${f.seq} actor=${f.command.actor} type=${f.command.type}`),p?.name==="loopback"&&f.command.actor===a)return;I(f,"remote");return}}),p.start()};o.setHandlers({onSkillClick(m){const w=Dn(l,m,{game:i,localSide:a,connected:b});l=w.next,w.command?T(w.command):k()},onCellClick(m){const w=Xn(l,m,{game:i,localSide:a,connected:b});l=w.next,w.command?T(w.command):k()},onEndTurnClick(){const m=Fn(l,{game:i,localSide:a,connected:b,ballisticPending:y});l=m.next,m.command?T(m.command):k()},onSpiritAdjust(m){l=Un(l,m,{game:i,localSide:a}).next,k()},onUnlockSkill(m){T(vn(a,m))}}),r.onSideChange(m=>{a=m,l=le(),y=!1,r.log(`本机控制方: ${m==="blue"?"P1/蓝方":"P2/红方"}`),k()}),r.onConnectAction(m=>{if(r.setInviteHash(""),l=le(),y=!1,m.mode==="receiver"){E="receiver",C=null,R(wt(It(),N)),r.log("已启动接收模式，等待生成联机码");return}const w=uo(m.codeInput);if(!w){r.log("联机码无效");return}E="connector",C=w,R(wt(It(),N)),r.log("已启动连接模式，正在连接远端")}),r.onStartLoopback(()=>{E=null,C=null,y=!1;const m=Qn();R(m),m.connect("self")}),k()}po().catch(e=>{console.error(e)});
